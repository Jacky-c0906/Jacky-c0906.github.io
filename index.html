<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>状态导向音乐</title>
  <style>
    :root{
      --bg:#f7f6f2; --ink:#1b1b1b; --ink-2:#3a3a3a;
      --jade:#128a7e; --jade-2:#0f6f66; --gold:#c7a86e; --muted:#6e6a5e; --paper:#fffdf6;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0f1213; --ink:#e8e6df; --ink-2:#d5d2c7; --jade:#5bc6b9; --jade-2:#3da99d; --gold:#bda161; --muted:#a7a296; --paper:#121517; }
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Segoe UI",system-ui,-apple-system,Roboto,"PingFang SC","Hiragino Sans GB","Microsoft Yahei","Noto Serif SC",serif;}
    body:before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background:
        radial-gradient(1000px 700px at 10% 0%,rgba(0,0,0,.06),transparent 70%),
        radial-gradient(900px 600px at 100% 100%,rgba(0,0,0,.05),transparent 60%),
        radial-gradient(800px 600px at 50% 120%,rgba(0,0,0,.04),transparent 60%);
      mix-blend-mode:multiply; opacity:.5;
    }
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.6)),var(--bg);backdrop-filter:blur(6px);border-bottom:2px solid var(--gold);box-shadow:0 2px 0 rgba(0,0,0,.03)}
    .wrap{max-width:1100px;margin:auto;padding:14px 16px}
    .title{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .brand{font-family:"STKaiti","Kaiti SC","KaiTi","Noto Serif SC",serif;font-size:28px;letter-spacing:.1em;color:var(--ink-2)}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--paper);border:2px solid var(--gold);border-radius:12px;overflow:hidden;box-shadow:0 10px 20px rgba(0,0,0,.05)}
    .panel-head{padding:10px 14px;background:linear-gradient(90deg,rgba(199,168,110,.25),rgba(199,168,110,.08) 40%,transparent),linear-gradient(180deg,rgba(255,255,255,.6),transparent);font-family:"STKaiti","Kaiti SC","KaiTi",serif;color:var(--jade-2);display:flex;align-items:center;gap:10px;justify-content:space-between;border-bottom:1px dashed var(--gold)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;padding:10px}
    .tab{cursor:pointer;user-select:none;padding:6px 12px 6px 10px;border:1px solid var(--jade-2);color:var(--jade-2);border-radius:0 10px 10px 0;position:relative;background:rgba(18,138,126,.08)}
    .tab:before{content:"";position:absolute;left:-10px;top:-1px;bottom:-1px;width:12px;background:linear-gradient(180deg,var(--jade),var(--jade-2));border:1px solid var(--jade-2);border-right:none;border-radius:6px 0 0 6px}
    .tab.active,.tab:hover{background:rgba(18,138,126,.15);color:#0b4a44}
    .list{max-height:60vh;overflow:auto}
    .btn{all:unset;display:flex;align-items:center;gap:10px;width:100%;padding:11px 14px;border-bottom:1px dashed rgba(199,168,110,.6);cursor:pointer}
    .btn:hover{background:rgba(199,168,110,.10)}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--jade-2)}
    .meta{color:var(--muted);font-size:12px}
    .empty{padding:12px;color:var(--muted)}
    .now{padding:12px 14px;color:var(--ink-2)}
    audio{width:100%;height:40px;filter:saturate(.9) contrast(1.05)}
    .scroll{padding:10px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{border:1px dashed var(--gold);padding:6px 10px;border-radius:999px;cursor:pointer;color:var(--ink-2);background:linear-gradient(180deg,rgba(199,168,110,.15),rgba(199,168,110,.05))}
    .chip:hover{transform:translateY(-1px)}
    .search{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid var(--gold);border-radius:8px;margin:10px}
    footer{max-width:1100px;margin:20px auto;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap title">
      <div class="brand">状态导向音乐</div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="panel">
        <div class="panel-head"><div>曲目清单</div></div>
        <div class="tabs" id="filters"></div>
        <input id="q" class="search" placeholder="检索标题、链接或路径…" />
        <div class="list" id="trackList"></div>
        <div class="empty" id="emptyMsg" style="display:none">无相应曲目</div>
      </section>

      <section class="panel">
        <div class="panel-head">
          <div><!-- 标题留空（原“云琴”已移除） --></div>
          <div class="meta" id="countMeta"></div>
        </div>
        <div class="now" id="nowPlaying">未选曲</div>
        <div class="scroll">
          <span class="chip" id="prevBtn">上一首</span>
          <span class="chip" id="nextBtn">下一首</span>
          <span class="chip" id="loopBtn">循环：关</span>
        </div>
        <div style="padding:0 12px 12px">
          <audio id="player" controls preload="none" crossorigin="anonymous"></audio>
        </div>
      </section>
    </div>
  </main>

  <footer>注：GitHub 代码页不预览大文件，但此页可正常播放。</footer>

  <script>
    const JSON_URL = "data/tracks.json";
    const GROUP_MAP = {
      "GSMT合成音乐": "GSMT",
      "chen_music": "臣",
      "shi_music": "使",
      "zuo_music": "佐",
      "jun_music": "君"
    };

    function isDir(item){
      const p = String(item.url || item.key || "");
      return p.endsWith("/");
    }
    function getTopPrefix(item){
      const src = String(item.key || item.url || "");
      const parts = src.replace(/^https?:\/\/[^/]+\//, "").split("/");
      return parts[0] || "";
    }
    function getFileName(urlOrKey){
      const s = String(urlOrKey || "");
      const seg = s.split("/").filter(Boolean);
      return seg[seg.length-1] || s;
    }

    let allTracks = [];
    let viewTracks = [];
    let currentGroup = "全部";
    let currentIndex = -1;

    const filtersEl = document.getElementById("filters");
    const listEl = document.getElementById("trackList");
    const emptyMsg = document.getElementById("emptyMsg");
    const player = document.getElementById("player");
    const now = document.getElementById("nowPlaying");
    const q = document.getElementById("q");
    const countMeta = document.getElementById("countMeta");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const loopBtn = document.getElementById("loopBtn");

    let loop = false;

    async function load() {
      try {
        const res = await fetch(JSON_URL + "?ts=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const raw = await res.json();

        allTracks = (Array.isArray(raw) ? raw : [])
          .filter(item => item && item.url && item.key)
          .filter(item => !isDir(item))
          .map((item) => {
            const prefix = getTopPrefix(item);
            const group = GROUP_MAP[prefix] || "未分组";
            const title = item.title && item.title.trim()
              ? item.title.trim()
              : getFileName(item.key || item.url);
            return { title, url: item.url, key: item.key, group };
          });

        renderFilters();
        renderList();
      } catch (e) {
        emptyMsg.style.display = "block";
        emptyMsg.textContent = "加载 " + JSON_URL + " 失败：" + e.message;
      }
    }

    function renderFilters(){
      const groups = ["全部", ...[...new Set(allTracks.map(t => t.group))].sort((a,b)=>a.localeCompare(b,"zh"))];
      filtersEl.innerHTML = "";
      groups.forEach(g=>{
        const tab = document.createElement("div");
        tab.textContent = g;
        tab.className = "tab" + (currentGroup===g?" active":"");
        tab.onclick = ()=>{ currentGroup=g; renderFilters(); renderList(); };
        filtersEl.appendChild(tab);
      });
    }

    function renderList(){
      let data = [...allTracks];
      if(currentGroup!=="全部") data = data.filter(t=>t.group===currentGroup);
      const keyword = q.value?.trim();
      if(keyword) {
        const k = keyword.toLowerCase();
        data = data.filter(t =>
          (t.title||"").toLowerCase().includes(k) ||
          (t.url||"").toLowerCase().includes(k) ||
          (t.key||"").toLowerCase().includes(k) ||
          (t.group||"").toLowerCase().includes(k)
        );
      }

      viewTracks = data;
      countMeta.textContent = "共 " + data.length + " 首";
      listEl.innerHTML = "";
      if(data.length===0){ emptyMsg.style.display="block"; return; }
      emptyMsg.style.display="none";

      data.forEach((t,i)=>{
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.innerHTML = `<span class="dot"></span><span>${t.title}</span><span class="meta">· ${t.group}</span>`;
        btn.title = t.key || t.url;
        btn.onclick = ()=> playIndex(i);
        listEl.appendChild(btn);
      });
      if(currentIndex>=0 && currentIndex>=data.length){ currentIndex = -1; }
    }

    function playIndex(i){
      currentIndex = i;
      const t = viewTracks[i];
      if(!t) return;
      player.src = t.url;
      player.play().catch(()=>{});
      now.textContent = "正奏： " + (t.title || "") + "  (" + (t.key || t.url) + ")";
      const el = listEl.children[i];
      if(el && el.scrollIntoView) el.scrollIntoView({block:"nearest"});
    }

    prevBtn.onclick = ()=> { if(viewTracks.length){ currentIndex = (currentIndex<=0 ? viewTracks.length-1 : currentIndex-1); playIndex(currentIndex); } };
    nextBtn.onclick = ()=> { if(viewTracks.length){ currentIndex = (currentIndex+1) % viewTracks.length; playIndex(currentIndex); } };
    loopBtn.onclick = ()=> { loop = !loop; player.loop = loop; loopBtn.textContent = "循环：" + (loop ? "开" : "关"); };
    player.addEventListener("ended", ()=>{ if(!player.loop && viewTracks.length){ currentIndex = (currentIndex+1) % viewTracks.length; playIndex(currentIndex); } });

    q.addEventListener("input", renderList);
    load();
  </script>
</body>
</html>
